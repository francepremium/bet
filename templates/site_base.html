{% load i18n %}
{% load localeurl_tags %}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="{% if LANGUAGE_BIDI %}rtl{% else %}ltr{% endif %}" xml:lang="{{ LANGUAGE_CODE }}" lang="{{ LANGUAGE_CODE }}">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <title>{% block head_title_base %}{% if SITE_NAME %}{{ SITE_NAME }} : {% endif %}{% block head_title %}{% endblock %}{% endblock %}</title>
        <link rel="stylesheet" href="{{ STATIC_URL }}pinax/css/base.css" />
        <link rel="stylesheet" href="{{ STATIC_URL }}pinax/css/tabs.css" />
        <link rel="stylesheet" href="{{ STATIC_URL }}pinax/css/facebox.css" />
        <link rel="stylesheet" href="{{ STATIC_URL }}pinax/css/announcements.css" />
        <link rel="stylesheet" href="{{ STATIC_URL }}pinax/css/accounts.css" />
        <link rel="stylesheet" href="{{ STATIC_URL }}uni_form/uni-form.css" />
        <link rel="stylesheet" href="{{ STATIC_URL }}css/ui-lightness/jquery-ui-1.8.13.custom.css" />
        {% if LANGUAGE_BIDI %}
        <style type="text/css" media="screen">
            div.right_panel {
                float: left; /* hotfix for sidebar */
            }
        </style>
        {% endif %}
        {% block extra_head_base %}
            {% block extra_head %}{% endblock %}
        {% endblock %}
        <style type="text/css">
.winner, .draw {
    background-color: grey;
}
td.score.left, td.score.right {
    text-align: center;
    width: 32px;
}
tr.win td.score {
    background-color: green;
}
tr.lost td.score {
    background-color: red;
}
tr.draw td.score {
    background-color: orange;
}
tr.Fixture td.score {
    background-color: grey;
}
tr.Fixture td.score.left {
    text-align: right;
}
tr.Fixture td.score.right {
    text-align: left;
}
#global_bet_form .session, #global_bet_form .bettype, #global_bet_form .results_on_deck, #global_bet_form .choice { display: none; }
div.tree ul, .tab_content { display: none; }
table.bettype table.choices td,
table.bettype table.choices tr,
table.bettype table.choices {
    border-collapse: collapse;
    border: 1px solid black;
}
#ajaxload {
    cursor: pointer;
    left: 45%;
    position: fixed;
    top: 12px;
}
ul#messages {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 2;
}
        </style>
    </head>
    
    <body class="{% block body_class %}{% endblock %}">
        <div id="ajaxload">
            <img src="{{ STATIC_URL }}img/ajax-loader.gif" />
        </div>

        {% if site_wide_announcements %}
            <div id="site_wide_announcements">
                <ul>
                    {% for announcement in site_wide_announcements %}
                    <li>
                        <a href="{{ announcement.get_absolute_url }}">{{ announcement }}</a> -
                        <a href="{% url announcement_hide announcement.pk %}?next={{ request.path }}">{% trans "Hide announcement" %}</a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        <div id="global_bet_form"></div>

        <div id="tabhead">
            <div class="logo" dir="ltr">
                {% for lang in LANGUAGES %}
                    {% ifequal lang.0 LANGUAGE_CODE %}
                        <li class="selected">{{ lang.1 }}</li>
                    {% else %}
                        <li><a href="{{ request.path|chlocale:lang.0 }}">{{ lang.1 }}</a></li>
                    {% endifequal %}
                {% endfor %}
            </div>
            <div class="login">{% block login %}{% include "_account_bar.html" %}{% endblock %}{% block locale_switcher %}{% endblock %}<div style="text-align: right;"></div></div>
            <div id="right_tabs" >{% block right_tabs %}
                <ul class="tabs">
                    <li>
                        <a href="{% url gsm_sport_detail 'soccer' %}">{% trans "soccer" %}</a>
                    </li>
                    <li>
                        <a href="{% url gsm_sport_detail 'tennis' %}">{% trans "tennis" %}</a>
                    </li>
                    <li>
                        <a href="{% url gsm_sport_detail 'rugby' %}">{% trans "rugby" %}</a>
                    </li>
                    <li>
                        <a href="{% url gsm_sport_detail 'basketball' %}">{% trans "basketball" %}</a>
                    </li>
                </ul>
            {% endblock %}</div>
        </div>
        <div id="subnav" class="clearfix">{% block subnav_base %}<div class="clearfix">{% block subnav %}&nbsp;{% endblock %}</div>{% endblock %}</div>
        
        {% block body_outer %}
        <div id="body">
            <ul id="messages">
                {% if messages %}
                    {% for message in messages %}
                    <li id="message_{{ forloop.counter }}"{% if message.tags %} class="{{ message.tags }}"{% endif %}>
                        <a href="#"><small>{% trans "clear" %}</small></a>
                        {{ message }}
                    </li>
                    {% endfor %}
                {% endif %}
            </ul>
            
            {% block body %}
            {% endblock %}
            
        </div>
        {% endblock %}
        
        <div id="footer">{% block footer %}{% endblock %}</div>
        
        <script src="{% block jquery_src %}{{ STATIC_URL }}js/jquery-1.5.1.min.js{% endblock %}" type="text/javascript"></script>
        <script src="{{ STATIC_URL }}pinax/js/base.js" type="text/javascript"></script>
        <script src="{{ STATIC_URL }}uni_form/uni-form.jquery.js" type="text/javascript"></script>
        <script src="{{ STATIC_URL }}js/jquery-ui-1.8.13.custom.min.js" type="text/javascript"></script>
        {% include "facebox_js.html" %}
        <script type="text/javascript">
        $.ajaxSetup({
            beforeSend: function(req) {},
            error: function(req, textStatus, error) {
                if (textStatus == 'error') {
                    add_message('{% trans 'Sorry, our program failed to process your request. Our techie has been notified by email and will take care of it soonish' %}');
                }
            },
        });

        $('#ajaxload').ajaxStop(function() {
            $(this).fadeOut();
        });
        $('#ajaxload').ajaxStart(function() {
            $(this).fadeIn();
        });

        function add_message(message) {
            var li = $('<li class="success">'+message+'<a href="#"><small>{% trans 'clear' %}</small></a></li>');
            li.attr('style', 'display:none');
            $('ul#messages').append(li);
            li.slideDown();
            window.setTimeout(function() {
                li.slideUp();
            }, 3000);
        }
        $(document).ready(function() {
            $('.tab_link').live('click', function(e) {
                var tabid = $(this).attr('class').match(/tab_id_([a-z]*)/)[1];
                var group = $(this).attr('class').match(/tab_group_([a-z]*)/);
                if (group && group.length) {
                    var tabgroup = group[1];
                    $('.tab_content.tab_group_'+tabgroup).hide().removeClass('selected');
                    $('.tab_content.tab_id_'+tabid+'.tab_group_'+tabgroup).show().addClass('selected');
                } else {
                    $('.tab_content').hide().removeClass('selected');
                    $('.tab_content.tab_id_'+tabid).show().addClass('selected');
                }
            });
            $('.tab_link:first').click();

            $('div.tree').click(function(e) {
                if ($(this).find('ul:visible').length) {
                    return true;
                }
                if ($('div.tree ul:visible').length) {
                    $('div.tree ul').slideUp('fast');
                }
                $(this).find('ul').slideDown();
            });
            
            function load_global_bet_html(html) {
                var container = $('div#global_bet_form');
                if (container.css('display') != 'none') {
                    container.slideUp('fast', function() {
                        container.html(html);
                    });
                } else {
                    container.html(html);
                }

                var session_text = container.find('input[name=session_text]');
                var session = container.find('div.session div.results_on_deck div');
                var session_display = session.html()
                if (session && session_text && session_display) {
                    session_display = session_display.replace('<span class="iconic" id="kill_id_session">X</span>', '');
                    session_display = $.trim(session_display);
                    session_text.val(session_display);
                }

                var url = container.find('form').attr('action');
                if (typeof url == 'string') {
                    var m = url.match(/\?pronostic=([0-9]+)/);
                    if (m && m.length == 2) {
                        var pk = m[1];
                    } else {
                        var pk = false;
                    }
                    if (pk) {
                        $('#global_bet_form div.session, #global_bet_form div.bettype, #global_bet_form div.choice').show();
                    } else {
                        $('#global_bet_form div.session, #global_bet_form div.bettype, #global_bet_form div.choice').hide();
                    }
                }

                container.slideDown();
            }
            function load_global_bet_url(url) {
                var container = $('div#global_bet_form');
                container.slideUp();
                $.get(url, {}, function(data, textStatus, jqXHR) {
                    load_global_bet_html(data);
                });
            }

            $('a').live('click', function(e) {                
                if ($(this).attr('href') == '{% url bet_add %}' || $(this).attr('href').match('{% url bet_pronostic_form '[0-9]+' %}') != null) {
                    e.preventDefault();
                    load_global_bet_url($(this).attr('href'));
                }
            });

            function update_select(select, data) {
                select.find('option').remove();
                select.append($('<option value="">-------</option>'));
                for (var i in data) {
                    select.append($('<option value="'+data[i][0]+'">'+data[i][1]+'</option>'));
                }
            }

            /*
            sport select:
            - empty session autocomplete
            - update session autocomplete source
            - show session autocomplete
            - update bettypes select
            - trigger bettype change
            - show bettype select
            */
            $('#global_bet_form select[name=sport]').live('change', function(e) {
                $('#global_bet_form input[name=session_text]').val('');
                $('#global_bet_form input[name=session]').val('');

                var old_source = $('#global_bet_form input[name=session_text]').autocomplete( "option", "source");
                if (old_source.match(/sport=/)) {
                    new_source = old_source.replace(/sport=[^&]$/, 'sport=' + $(this).val());
                } else {
                    if (old_source.match(/\?/)) {
                        new_source = old_source + '&sport=' + $(this).val();
                    } else {
                        new_source = old_source + '?sport=' + $(this).val();
                    }
                }
                $('#global_bet_form input[name=session_text]').autocomplete( "option", "source", new_source);
                $('#global_bet_form div.session').fadeIn();

                var bookmaker = $('#global_bet_form div.bookmaker');
                var bookmaker_pk = bookmaker.attr('class').match(/pk_([0-9]+)/)[1];
                var bettypes = $('#global_bet_form select[name=bettype]');
                $.get(
                    '{% url bookmaker_bet_types_for_bookmaker_and_sport %}',
                    {
                        'sport': $('#global_bet_form select[name=sport]').val(),
                        'bookmaker': bookmaker_pk,
                    },
                    function(data, textStatus, jqXHR) {
                        update_select(bettypes, data);
                        $('#global_bet_form div.bettype').fadeIn();
                    },
                    'json'
                );
                bettypes.trigger('change');
            });

            /*
            bettype select:
            - empty choices
            - update choices select
            - show choices
            */
            $('#global_bet_form select[name=bettype]').live('change', function(e) {
                if ($(this).val() == null) {
                    $('#global_bet_form div.choice').fadeOut();
                    return false;
                }
                $.get(
                    '{% url bookmaker_bet_choices_for_bettype %}',
                    {
                        'bettype': $('#global_bet_form select[name=bettype]').val(),
                    },
                    function(data, textStatus, jqXHR) {
                        update_select($('#global_bet_form select[name=choice]'), data);
                        $('#global_bet_form div.choice').fadeIn();
                    },
                    'json'
                );
            });

            $('#global_bet_form select[name=stake], #global_bet_form select[name=bookmaker]').live('change', function(e) {
                if ($('#global_bet_form select[name=stake]').val() && $('#global_bet_form select[name=bookmaker]').val()) {
                    $(this).parents('form').trigger('submit');
                }
            });
            $('#global_bet_form select[name=choice]').live('change', function(e) {
                if ($(this).val()) {
                    $(this).parents('form').trigger('submit');
                }
            });

            $('#global_bet_form form').live('submit', function(e) {
                e.preventDefault();

                $.post(
                    $(this).attr('action'),
                    $(this).serialize(),
                    function (data, textStatus, jqHXR) {
                        load_global_bet_html(data);
                    },
                    'html'
                );
            });
            
            $('#ajaxload').fadeOut();
        });
        </script>
        {% block extra_body_base %}
            {% block extra_body %}{% endblock %}
        {% endblock %}
    </body>
</html>
